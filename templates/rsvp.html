<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Speed Reader (RSVP)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=IBM+Plex+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Monochrome palette */
      --bg-deep: #050505;
      --bg-base: #0a0a0a;
      --bg-raised: #111111;
      --bg-elevated: #1a1a1a;
      --border-subtle: #1f1f1f;
      --border-default: #2a2a2a;
      --text-muted: #555;
      --text-secondary: #888;
      --text-primary: #ccc;
      --text-bright: #fff;
      /* Single accent */
      --accent: #e63946;
      --accent-glow: rgba(230, 57, 70, 0.15);
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg-base);
      min-height: 100vh;
      font-family: 'IBM Plex Sans', -apple-system, sans-serif;
      color: var(--text-primary);
    }

    /* Override Pico defaults for unified buttons */
    button, [type="button"], [type="submit"] {
      --pico-primary: var(--text-secondary);
      --pico-primary-hover: var(--text-bright);
      --pico-primary-background: transparent;
      --pico-primary-border: var(--border-default);
      background: transparent !important;
      border: 1px solid var(--border-default) !important;
      color: var(--text-secondary) !important;
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 500;
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      height: auto;
      line-height: 1.4;
      transition: all 0.15s ease;
    }
    button:hover, [type="button"]:hover, [type="submit"]:hover {
      border-color: var(--text-muted) !important;
      color: var(--text-bright) !important;
      background: var(--bg-elevated) !important;
    }
    button:disabled, [type="button"]:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    button.primary-action {
      background: var(--bg-elevated) !important;
      border-color: var(--text-muted) !important;
      color: var(--text-bright) !important;
    }
    button.primary-action:hover {
      background: var(--border-default) !important;
    }

    .reader-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Two-column layout on desktop */
    @media (min-width: 900px) {
      .main-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2.5rem;
        align-items: start;
      }
      .input-section {
        margin-top: 0 !important;
        padding-top: 0 !important;
        border-top: none !important;
      }
    }

    /* Word display - the focus chamber */
    .word-display {
      background: var(--bg-deep);
      padding: 4rem 2rem;
      margin: 1.5rem 0;
      text-align: center;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
    }
    .word-display::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      background: radial-gradient(ellipse at center, var(--accent-glow) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    .reading .word-display::before { opacity: 1; }

    .word {
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      font-size: clamp(2.5rem, 8vw, 4.5rem);
      font-weight: 600;
      white-space: pre;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      width: 100%;
      letter-spacing: -0.02em;
    }
    .word .before { color: var(--text-bright); text-align: right; }
    .word .orp { color: var(--accent); text-align: center; text-shadow: 0 0 30px var(--accent-glow); }
    .word .after { color: var(--text-bright); text-align: left; }

    /* Stats bar */
    .stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 0 0.5rem;
      letter-spacing: 0.02em;
    }
    .wpm {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1.5rem 0;
    }
    .controls button {
      min-width: 90px;
      padding: 0.6rem 1.25rem;
      font-size: 0.9rem;
      border-radius: 6px;
    }

    /* Speed controls */
    .speed-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: center;
      margin: 1.5rem 0;
      transition: opacity 0.3s ease;
    }
    .speed-controls.dimmed { opacity: 0.3; }
    .speed-controls.dimmed:hover { opacity: 0.7; }
    .speed-controls button {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .wpm-display {
      min-width: 90px;
      text-align: center;
      padding: 0.35rem 0.75rem;
      border-radius: 6px;
      font-variant-numeric: tabular-nums;
      color: var(--text-secondary);
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .wpm-display:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    /* Input elements */
    textarea, input[type="text"], input[type="url"] {
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 0.85rem;
      background: var(--bg-elevated) !important;
      border: 1px solid var(--border-default) !important;
      color: var(--text-primary) !important;
      border-radius: 5px;
      padding: 0.4rem 0.6rem;
      transition: border-color 0.15s ease;
    }
    textarea:focus, input[type="text"]:focus, input[type="url"]:focus {
      border-color: var(--text-muted) !important;
      outline: none;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      padding: 0.5rem 0.6rem;
    }
    textarea::placeholder, input::placeholder {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .input-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-subtle);
    }

    .idle-message {
      color: var(--text-muted);
      font-size: 1.1rem;
      animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    .back-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
      transition: color 0.2s ease;
      display: inline-block;
      margin-bottom: 0.5rem;
    }
    .back-link:hover { color: var(--text-primary); }

    h1 {
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 500;
      color: var(--text-bright);
      font-size: 1.75rem;
      letter-spacing: -0.02em;
    }

    /* Keyboard hints */
    .keyboard-hints {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 1.5rem;
      padding: 0.75rem 1rem;
      background: var(--bg-raised);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }
    .keyboard-hints kbd {
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 4px;
      padding: 0.15rem 0.4rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin: 0 0.1rem;
    }

    /* Library section */
    .library-section {
      background: var(--bg-raised);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 0.875rem;
      margin-bottom: 0.875rem;
    }
    .library-header {
      margin-bottom: 0.5rem;
    }
    .library-header h3 {
      margin: 0;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 500;
    }
    .library-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      max-height: 160px;
      overflow-y: auto;
    }
    .library-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.65rem;
      background: var(--bg-elevated);
      border-radius: 5px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .library-item:hover {
      background: var(--bg-base);
      border-color: var(--border-default);
    }
    .library-item.active {
      background: var(--bg-base);
      border-left: 2px solid var(--accent);
      padding-left: calc(0.65rem - 1px);
    }
    .library-item .info { flex: 1; min-width: 0; cursor: pointer; }
    .library-item .title {
      font-weight: 500;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }
    .library-item .meta {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
      margin-top: 0.1rem;
      font-variant-numeric: tabular-nums;
    }
    .library-item .meta .position { color: var(--text-secondary); }
    .library-item .actions {
      display: flex;
      gap: 0.25rem;
      opacity: 0;
      transition: opacity 0.15s ease;
      margin-left: 0.5rem;
    }
    .library-item:hover .actions { opacity: 1; }
    .library-item .actions button {
      padding: 0.15rem 0.4rem;
      font-size: 0.65rem;
      min-width: auto;
      border-radius: 3px;
    }
    .library-empty {
      color: var(--text-muted);
      text-align: center;
      padding: 1rem;
      font-size: 0.8rem;
    }

    /* Save dialog */
    .save-dialog {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: 0.6rem;
      padding-top: 0.6rem;
      border-top: 1px solid var(--border-subtle);
    }
    .save-dialog input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      font-size: 0.8rem;
    }
    .save-dialog .btn-row {
      display: flex;
      gap: 0.4rem;
    }

    /* Import section */
    .import-section {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 0.875rem;
      padding: 0.75rem;
      background: var(--bg-raised);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
    }
    .import-section input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      font-size: 0.8rem;
    }
    .import-section .btn-row {
      display: flex;
      gap: 0.4rem;
    }
    .file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid var(--border-default) !important;
      border-radius: 5px;
      color: var(--text-secondary) !important;
      background: transparent !important;
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 500;
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      height: auto;
      line-height: 1.4;
      box-sizing: border-box;
      transition: all 0.15s ease;
    }
    .file-label:hover {
      border-color: var(--text-muted) !important;
      color: var(--text-bright) !important;
      background: var(--bg-elevated) !important;
    }
    .import-error {
      color: var(--accent);
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    /* Loaded text info */
    .loaded-info {
      background: var(--bg-raised);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .loaded-info .title-line {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .loaded-info .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Completion state */
    .complete-message {
      text-align: center;
    }
    .complete-message .heading {
      color: var(--text-bright);
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }
    .complete-message .stats {
      color: var(--text-muted);
      font-size: 0.9rem;
      justify-content: center;
    }

    /* Label styling */
    label:not(.file-label) {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.35rem;
      display: block;
    }
    small {
      color: var(--text-muted);
      font-size: 0.75rem;
      display: block;
      margin-top: 0.35rem;
    }

    /* Reading mode - hide distractions */
    .reading .back-link,
    .reading h1,
    .reading h1 + p { display: none; }
  </style>
</head>
<body data-class="{'reading': $running}"
      data-on:keydown__window="
        evt.key === ' ' ? ($running ? @get('/rsvp/pause') : ($total_words > 0 ? @get('/rsvp/start') : null), evt.preventDefault()) :
        evt.key === 'Escape' && $running ? (@get('/rsvp/pause'), evt.preventDefault()) :
        evt.key === 'ArrowUp' ? (@get('/rsvp/faster'), evt.preventDefault()) :
        evt.key === 'ArrowDown' ? (@get('/rsvp/slower'), evt.preventDefault()) :
        null
      ">
  <main class="reader-container"
        data-signals='{
          "word": "", "before": "", "orp": "", "after": "",
          "wpm": {{ active.wpm if active else 300 }}, "progress": 0, "running": false,
          "total_words": {{ active.total_words if active else 0 }}, "current_word": {{ active.position if active else 0 }},
          "text": "", "text_id": null, "title": {{ (active.title|tojson) if active else '""' }},
          "completed": false, "saveTitle": {{ (active.title|tojson) if active else '""' }},
          "importUrl": "", "importError": "", "importing": false,
          "textPreview": "", "textLoaded": {{ "true" if active else "false" }}
        }'>
    <a href="/" class="back-link" data-show="!$running">&larr; Back to demos</a>

    <h1 data-show="!$running">Speed Reader</h1>
    <p data-show="!$running" style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.95rem;">RSVP · read faster by eliminating eye movement</p>

    <div class="main-layout">
      <div class="reader-area">
        <!-- Stats -->
        <div class="stats">
          <span>Word <span data-text="$current_word"></span> of <span data-text="$total_words"></span></span>
          <span class="wpm"><span data-text="$wpm"></span> WPM</span>
        </div>

        <div class="word-display">
        <div class="word" data-show="$running || $word">
          <span class="before" data-text="$before"></span><span class="orp" data-text="$orp"></span><span class="after" data-text="$after"></span>
        </div>
        <div class="idle-message" data-show="!$running && !$word && !$completed && $total_words === 0">
          Select a text from library or paste new text
        </div>
        <div class="idle-message" data-show="!$running && !$word && !$completed && $total_words > 0">
          Press Start or Space to begin
        </div>
        <div class="complete-message" data-show="$completed && !$running">
          <div class="heading">Reading Complete</div>
          <div><span data-text="$total_words"></span> words at <span data-text="$wpm"></span> WPM</div>
        </div>
      </div>

      <!-- Speed controls -->
      <div class="speed-controls" data-class="{'dimmed': $running}">
        <button data-on:click="@get('/rsvp/slower')" title="Slower (↓)">−</button>
        <span class="wpm-display" data-text="$wpm + ' WPM'" title="Reading speed"></span>
        <button data-on:click="@get('/rsvp/faster')" title="Faster (↑)">+</button>
      </div>

      <!-- Main controls -->
      <div class="controls">
        <button
          class="primary-action"
          data-on:click="@get('/rsvp/start')"
          data-show="!$running"
          data-attr-disabled="$total_words < 1"
        >Start</button>
        <button data-on:click="@get('/rsvp/pause')" data-show="$running">Pause</button>
        <button data-on:click="@get('/rsvp/reset')" data-attr-disabled="$total_words < 1">Reset</button>
      </div>

      <!-- Keyboard hints -->
      <div class="keyboard-hints" data-show="!$running">
        <kbd>Space</kbd> Start/Pause &nbsp;
        <kbd>↑</kbd><kbd>↓</kbd> Speed &nbsp;
        <kbd>Esc</kbd> Pause
      </div>
      </div><!-- end reader-area -->

      <!-- Library section (sidebar on desktop) -->
      <div class="input-section" data-show="!$running">

        <!-- Library -->
        <div class="library-section">
          <div class="library-header">
            <h3>Library</h3>
          </div>

          <div class="library-list">
            {% if library %}
              {% for item in library %}
              <div class="library-item{% if loop.first %} active{% endif %}"
                   data-class="{'active': $text_id === '{{ item.id }}'}">
                <div class="info" data-on:click="@get('/rsvp/library/load/{{ item.id }}')">
                  <div class="title">{{ item.title }}</div>
                  <div class="meta">
                    {% if item.position > 0 %}
                    <span class="position">{{ item.position }}/{{ item.word_count }}</span>
                    {% else %}
                    <span>{{ item.word_count }} words</span>
                    {% endif %}
                  </div>
                </div>
                <div class="actions">
                  <button data-on:click.stop="@get('/rsvp/library/delete/{{ item.id }}')" title="Delete">✕</button>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="library-empty">No saved texts yet. Paste text below and save it.</div>
            {% endif %}
          </div>

          <!-- Save new text -->
          <div class="save-dialog">
            <input type="text" placeholder="Title for new text..." data-bind="$saveTitle">
            <div class="btn-row">
              <button data-on:click="@get('/rsvp/library/save')" data-attr-disabled="$text.trim().length < 10">Save</button>
              <button data-show="$text_id" data-on:click="@get('/rsvp/library/delete/' + $text_id)">Delete</button>
            </div>
          </div>
        </div>

        <!-- Import from URL or EPUB -->
        <div class="import-section">
          <input type="url" placeholder="Paste article URL..." data-bind="$importUrl">
          <div class="btn-row">
            <button data-on:click="@get('/rsvp/import-url')" data-attr-disabled="!$importUrl || $importUrl.length < 10">Import URL</button>
            <label class="file-label">
              EPUB
              <input type="file" accept=".epub" style="display: none;" onchange="window.uploadEpub(this)">
            </label>
          </div>
        </div>
        <div class="import-error" data-show="$importError" data-text="$importError"></div>

        <!-- Show info when text is loaded (URL or EPUB) -->
        <div class="loaded-info" data-show="$textLoaded && $total_words > 0">
          <div class="title-line">
            <span data-text="$title || 'Imported text'"></span> · <span data-text="$total_words"></span> words
          </div>
          <div class="hint">Press Start to begin reading, or Save to add to library.</div>
        </div>

        <!-- Textarea for manual input (hide when URL text loaded) -->
        <div data-show="!$textLoaded">
          <label for="text-input">Text to read:</label>
          <textarea
            id="text-input"
            placeholder="Paste or type your text here... (minimum 10 characters)"
            data-bind="$text"
          ></textarea>
          <small style="color:#666">Paste an article, book excerpt, or any text. Save it to library to track your progress.</small>
        </div>
      </div>

    </div>
  </main>

  <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-RC.7/bundles/datastar.js"></script>
  <script>
    // EPUB file upload handler
    window.uploadEpub = async function(input) {
      const file = input.files[0];
      if (!file || !file.name.endsWith('.epub')) {
        alert('Please select an EPUB file');
        return;
      }

      const formData = new FormData();
      formData.append('epub', file);

      try {
        const response = await fetch('/rsvp/import-epub', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();

        if (result.error) {
          // Update error signal
          const main = document.querySelector('[data-signals]');
          if (main && main._dsSignals) {
            main._dsSignals.importError.value = result.error;
          } else {
            alert('Error: ' + result.error);
          }
        } else if (result.success) {
          // Reload page to reflect new state (text is stored server-side)
          window.location.reload();
        }
      } catch (e) {
        console.error('Upload failed:', e);
        alert('Upload failed: ' + e.message);
      }
      // Reset input so same file can be selected again
      input.value = '';
    };
  </script>
</body>
</html>
