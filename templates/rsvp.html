<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Speed Reader (RSVP)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body {
      background: #0a0a0a;
      min-height: 100vh;
    }
    .reader-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    .word-display {
      background: #0a0a0a;
      padding: 3rem 2rem;
      margin: 1rem 0;
      text-align: center;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .word {
      font-family: 'Courier New', Consolas, monospace;
      font-size: 4rem;
      font-weight: bold;
      white-space: pre;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      width: 100%;
    }
    .word .before { color: #fff; text-align: right; }
    .word .orp { color: #e63946; text-align: center; }
    .word .after { color: #fff; text-align: left; }
    /* Progress bar */
    .progress-bar {
      background: #222;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
      margin: 0.5rem 0;
      width: 100%;
      max-width: 600px;
    }
    .progress-fill {
      background: linear-gradient(90deg, #e63946, #f4a261);
      height: 100%;
      transition: width 0.1s linear;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .wpm { font-size: 1.2rem; color: #f4a261; font-weight: bold; }
    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1.5rem 0;
    }
    .controls button { min-width: 100px; }
    /* Speed controls */
    .speed-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      margin: 1rem 0;
      transition: opacity 0.3s;
    }
    .speed-controls.dimmed { opacity: 0.4; }
    .speed-controls.dimmed:hover { opacity: 0.9; }
    .speed-controls button {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 50%;
    }
    .wpm-display {
      min-width: 80px;
      text-align: center;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    .wpm-display:hover { background: #222; }
    textarea {
      font-family: inherit;
      min-height: 120px;
      background: #111;
      border: 1px solid #333;
    }
    .input-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #222;
    }
    .idle-message { color: #666; font-size: 1.5rem; }
    .back-link { color: #666; text-decoration: none; font-size: 0.9rem; }
    .back-link:hover { color: #fff; }
    .keyboard-hints {
      text-align: center;
      font-size: 0.75rem;
      color: #444;
      margin-top: 0.5rem;
    }
    .keyboard-hints kbd {
      background: #222;
      border: 1px solid #333;
      border-radius: 3px;
      padding: 0.1rem 0.4rem;
      font-family: monospace;
    }
    /* Library */
    .library-section {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .library-header h3 { margin: 0; font-size: 1rem; color: #888; }
    .library-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .library-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: #1a1a1a;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .library-item:hover { background: #252525; }
    .library-item.active { background: #1e1e2e; border-left: 3px solid #e63946; }
    .library-item .title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
    .library-item .meta { font-size: 0.8rem; color: #666; white-space: nowrap; }
    .library-item .meta .position { color: #4ade80; }
    .library-empty { color: #555; text-align: center; padding: 1rem; font-size: 0.9rem; }
    /* Save dialog */
    .save-dialog {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #222;
    }
    .save-dialog input {
      flex: 1;
      padding: 0.4rem 0.6rem;
      background: #1a1a1a;
      border: 1px solid #333;
      font-size: 0.9rem;
    }
    .save-dialog button { padding: 0.4rem 0.75rem; font-size: 0.85rem; }
    /* Import URL */
    .import-section {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
    }
    .import-section input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      font-size: 0.9rem;
    }
    .import-section button { padding: 0.5rem 1rem; white-space: nowrap; }
    .import-error { color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem; }
  </style>
</head>
<body data-on:keydown__window="
        evt.key === ' ' ? ($running ? @get('/rsvp/pause') : ($total_words > 0 ? @get('/rsvp/start') : null), evt.preventDefault()) :
        evt.key === 'Escape' && $running ? (@get('/rsvp/pause'), evt.preventDefault()) :
        evt.key === 'ArrowUp' ? (@get('/rsvp/faster'), evt.preventDefault()) :
        evt.key === 'ArrowDown' ? (@get('/rsvp/slower'), evt.preventDefault()) :
        null
      ">
  <main class="reader-container"
        data-signals='{
          "word": "", "before": "", "orp": "", "after": "",
          "wpm": {{ active.wpm if active else 300 }}, "progress": 0, "running": false,
          "total_words": {{ active.total_words if active else 0 }}, "current_word": {{ active.position if active else 0 }},
          "text": "", "text_id": null, "title": {{ (active.title|tojson) if active else '""' }},
          "completed": false, "saveTitle": {{ (active.title|tojson) if active else '""' }},
          "importUrl": "", "importError": "", "importing": false,
          "textPreview": "", "textLoaded": {{ "true" if active else "false" }}
        }'>
    <a href="/" class="back-link" data-show="!$running">&larr; Back to demos</a>

    <h1 data-show="!$running">Speed Reader</h1>
    <p data-show="!$running">RSVP (Rapid Serial Visual Presentation) - read faster by eliminating eye movement</p>

    <div>
      <!-- Progress bar -->
      <div class="progress-bar">
        <div class="progress-fill" data-attr-style="'width:' + ($progress * 100) + '%'"></div>
      </div>

      <!-- Stats -->
      <div class="stats">
        <span>Word <span data-text="$current_word"></span> of <span data-text="$total_words"></span></span>
        <span class="wpm"><span data-text="$wpm"></span> WPM</span>
      </div>

      <div class="word-display">
        <div class="word" data-show="$running || $word">
          <span class="before" data-text="$before"></span><span class="orp" data-text="$orp"></span><span class="after" data-text="$after"></span>
        </div>
        <div class="idle-message" data-show="!$running && !$word && !$completed && $total_words === 0">
          Select a text from library or paste new text
        </div>
        <div class="idle-message" data-show="!$running && !$word && !$completed && $total_words > 0">
          Press Start or Space to begin
        </div>
        <div data-show="$completed && !$running" style="text-align: center;">
          <div style="color: #4ade80; font-size: 1.5rem; margin-bottom: 1rem;">Reading Complete!</div>
          <div style="color: #666;"><span data-text="$total_words"></span> words at <span data-text="$wpm"></span> WPM</div>
        </div>
      </div>

      <!-- Speed controls -->
      <div class="speed-controls" data-class="{'dimmed': $running}">
        <button data-on:click="@get('/rsvp/slower')" class="outline" title="Slower (Arrow Down)">-</button>
        <span class="wpm-display" data-text="$wpm + ' WPM'" title="Reading speed"></span>
        <button data-on:click="@get('/rsvp/faster')" class="outline" title="Faster (Arrow Up)">+</button>
      </div>

      <!-- Main controls -->
      <div class="controls">
        <button
          data-on:click="@get('/rsvp/start')"
          data-show="!$running"
          data-attr-disabled="$total_words < 1"
        >Start</button>
        <button data-on:click="@get('/rsvp/pause')" data-show="$running" class="secondary">Pause</button>
        <button data-on:click="@get('/rsvp/reset')" class="outline" data-attr-disabled="$total_words < 1">Reset</button>
      </div>

      <!-- Keyboard hints -->
      <div class="keyboard-hints" data-show="!$running">
        <kbd>Space</kbd> Start/Pause &nbsp;
        <kbd>↑</kbd><kbd>↓</kbd> Speed &nbsp;
        <kbd>Esc</kbd> Pause
      </div>

      <!-- Library section (not during reading) -->
      <div class="input-section" data-show="!$running">

        <!-- Library -->
        <div class="library-section">
          <div class="library-header">
            <h3>Library</h3>
          </div>

          <div class="library-list">
            {% if library %}
              {% for item in library %}
              <div class="library-item{% if loop.first %} active{% endif %}"
                   data-class="{'active': $text_id === '{{ item.id }}'}"
                   data-on:click="@get('/rsvp/library/load/{{ item.id }}')">
                <div class="title">{{ item.title }}</div>
                <div class="meta">
                  {% if item.position > 0 %}
                  <span class="position">{{ item.position }}/{{ item.word_count }}</span>
                  {% else %}
                  <span>{{ item.word_count }} words</span>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="library-empty">No saved texts yet. Paste text below and save it.</div>
            {% endif %}
          </div>

          <!-- Save new text -->
          <div class="save-dialog">
            <input type="text" placeholder="Title for new text..." data-bind="$saveTitle">
            <button class="outline" data-on:click="@get('/rsvp/library/save')" data-attr-disabled="$text.trim().length < 10">Save</button>
            <button class="outline secondary" data-show="$text_id" data-on:click="@get('/rsvp/library/delete/' + $text_id)">Delete</button>
          </div>
        </div>

        <!-- Import from URL or EPUB -->
        <div class="import-section">
          <input type="url" placeholder="Paste article URL..." data-bind="$importUrl" style="flex: 2;">
          <button class="outline" data-on:click="@get('/rsvp/import-url')" data-attr-disabled="!$importUrl || $importUrl.length < 10">Import URL</button>
          <label class="outline file-label" style="padding: 0.5rem 1rem; cursor: pointer; border: 1px solid var(--pico-primary); border-radius: var(--pico-border-radius); color: var(--pico-primary);">
            EPUB
            <input type="file" accept=".epub" style="display: none;" onchange="window.uploadEpub(this)">
          </label>
        </div>
        <div class="import-error" data-show="$importError" data-text="$importError"></div>

        <!-- Show info when text is loaded (URL or EPUB) -->
        <div data-show="$textLoaded && $total_words > 0" style="background: #151515; border: 1px solid #333; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
          <div style="color: #4ade80; margin-bottom: 0.5rem;">
            <span data-text="$title || 'Imported text'"></span> (<span data-text="$total_words"></span> words)
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">Press Start to begin reading, or Save to add to library.</div>
        </div>

        <!-- Textarea for manual input (hide when URL text loaded) -->
        <div data-show="!$textLoaded">
          <label for="text-input">Text to read:</label>
          <textarea
            id="text-input"
            placeholder="Paste or type your text here... (minimum 10 characters)"
            data-bind="$text"
          ></textarea>
          <small style="color:#666">Paste an article, book excerpt, or any text. Save it to library to track your progress.</small>
        </div>
      </div>

    </div>
  </main>

  <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-RC.7/bundles/datastar.js"></script>
  <script>
    // EPUB file upload handler
    window.uploadEpub = async function(input) {
      const file = input.files[0];
      if (!file || !file.name.endsWith('.epub')) {
        alert('Please select an EPUB file');
        return;
      }

      const formData = new FormData();
      formData.append('epub', file);

      try {
        const response = await fetch('/rsvp/import-epub', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();

        if (result.error) {
          // Update error signal
          const main = document.querySelector('[data-signals]');
          if (main && main._dsSignals) {
            main._dsSignals.importError.value = result.error;
          } else {
            alert('Error: ' + result.error);
          }
        } else if (result.success) {
          // Reload page to reflect new state (text is stored server-side)
          window.location.reload();
        }
      } catch (e) {
        console.error('Upload failed:', e);
        alert('Upload failed: ' + e.message);
      }
      // Reset input so same file can be selected again
      input.value = '';
    };
  </script>
</body>
</html>
